import*as e from"three";import{GLTFLoader as t}from"three/addons/loaders/GLTFLoader.js";import{OrbitControls as a}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as n,CSS2DObject as i}from"three/addons/renderers/CSS2DRenderer.js";let gCanvas,gCamera,gScene,gRenderer,gLight,gCSS2DRenderer,gController;var gObjectId=null,gViewId=null,gElementList=[],gGTCamList=[],gDivList=[],gMesh=null,gRefView=null,gRunAnimation=!1,gRotRadius=0;function createCamera(t,a,n){let o=new e.TextureLoader,r=new e.MeshBasicMaterial({map:o.load(t)});r.transparent=!0,r.side=e.DoubleSide;let s=new e.PlaneGeometry(.8,.8),g=new e.Mesh(s,r);g.position.set(0,0,-1);let l=new e.PerspectiveCamera(45,1,.001,1);l.position.x=a.x,l.position.y=a.z,l.position.z=-a.y,l.lookAt(new e.Vector3(0,0,0));let c=new e.CameraHelper(l);c.add(g);let d=document.createElement("div");d.className="label",d.textContent=n,d.style.color="black",d.style.backgroundColor="transparent";let m=new i(d);return m.position.set(0,0,.2),m.center.set(0,1),m.layers.set(0),[l,c,d]}function createImageHtml(e){return'<div class="col-2"><img class="img-fluid img-thumbnail" src="'+e+'"></div>'}function addCamera(e,t,a,n,i){let o=createCamera(e,t,a),r=o[0],s=o[1],g=o[2];return s.setColors(n,n,n,n,n),gScene.add(r),gScene.add(s),r.updateProjectionMatrix(),s.update(),gElementList.push(r),gElementList.push(s),gDivList.push(g),i&&(s.visible=$("#switch_gt").is(":checked"),gGTCamList.push(s)),r}function loadCameras(t,a){null!=t&&null!=a&&fetch(t+"/"+a).then(e=>e.json()).then(a=>{$("#image_list").html("");var n="";let i=a.hasOwnProperty("anchor_vid")?a.obs[a.anchor_vid].sph:null;for(var o in null!=i&&(gCamera.position.x=1.2*i[2],gCamera.position.y=1.2*i[2],gCamera.position.z=1.2*i[2],gCamera.updateProjectionMatrix(),gController.target.set(0,0,0),gController.update(),gRotRadius=Math.sqrt(gCamera.position.x**2+gCamera.position.z**2+gCamera.position.y**2)),a.obs){let r=t+"/cam/"+a.obs[o].img_path;var s=null;if(a.obs[o].hasOwnProperty("xyz"))s=a.obs[o].xyz;else{let g=o==a.anchor_vid?[0,0,0]:a.obs[o].rel_sph;s=sphericalToCartesian(i[0]+g[0],i[1]+g[1],i[2]+g[2])}let l=new e.Color(o==a.anchor_vid?16733525:5592575),c=addCamera(r,s,o,l,!1);if(a.obs[o].hasOwnProperty("gt_rel_sph")){let d=a.obs[o].gt_rel_sph;addCamera(r,s=sphericalToCartesian(i[0]+d[0],i[1]+d[1],i[2]+d[2]),o,new e.Color(5635925),!0)}o==a.anchor_vid&&(gRefView=c),n+=createImageHtml(t+"/raw/"+a.obs[o].img_path)}$("#image_list").html(n),0==gGTCamList.length?($("#switch_gt").attr("checked",!1),$("#switch_gt").prop("disabled",!0)):$("#switch_gt").prop("disabled",!1)})}function loadObjMesh(e){let a=new t;$("#indicator").html("<b>Loading 3D mesh...</b>"),$('#obj_list button[data-toggle="list"]').prop("disabled",!0),a.load(e,function(e){$("#indicator").html(""),$('#obj_list button[data-toggle="list"]').prop("disabled",!1);let t=e.scene;t.position.x=0,t.position.y=0,t.position.z=0;let a=$("#mesh_size").val()/50*.75+.25;t.scale.x=a,t.scale.y=a,t.scale.z=a,t.traverse(e=>{e.isMesh&&(e.material.opacity=1,e.material.transparent=!0)}),gScene.add(t),gMesh=t})}function selectCollection(e,t){for(var a=0;a<gElementList.length;a++)gScene.remove(gElementList[a]);gElementList=[];for(var a=0;a<gDivList.length;a++)gDivList[a].remove();gDivList=[],gGTCamList=[],console.log(e,t),loadCameras("data/"+e,t+".json"),e!=gObjectId&&(gScene.remove(gMesh),gMesh=null,loadObjMesh("data/"+e+"/mesh.glb")),gObjectId=e,gViewId=t}function init(){gCanvas=document.getElementById("c"),(gScene=new e.Scene).background=new e.Color(15658734),gLight=new e.AmbientLight(16777215),gScene.add(gLight),$("#light_intensity").val(10),$("#mesh_size").val(50);let t=gCanvas.clientWidth,i=Math.max(600,gCanvas.clientHeight);(gCamera=new e.PerspectiveCamera(50,t/i,1,100)).position.x=5,gCamera.position.y=5,gCamera.position.z=5,selectCollection("toyduck_photo","pose2"),(gRenderer=new e.WebGLRenderer({canvas:gCanvas,antialias:!0})).setPixelRatio(window.devicePixelRatio),gRenderer.setSize(t,i),(gCSS2DRenderer=new n).setSize(t,i),gCSS2DRenderer.domElement.style.position="absolute",gCSS2DRenderer.domElement.style.top="0px",gCanvas.parentNode.appendChild(gCSS2DRenderer.domElement),gController=new a(gCamera,gCSS2DRenderer.domElement),window.addEventListener("resize",onWindowResize),document.addEventListener("keydown",onKeyDown)}function sphericalToCartesian(e,t,a){return{x:a*Math.sin(e)*Math.cos(t),y:a*Math.sin(e)*Math.sin(t),z:a*Math.cos(e)}}function cartesianToSpherical(e,t,a){let n=Math.pow(e,2)+Math.pow(t,2);return{theta:Math.atan2(Math.sqrt(n),a),azimuth:Math.atan2(t,e),radius:Math.sqrt(n+Math.pow(a,2))}}function onKeyDown(e){switch(e.keyCode){case 79:console.log(gCamera.position.x,gCamera.position.z,gCamera.position.y);let t=cartesianToSpherical(gCamera.position.x,gCamera.position.z,gCamera.position.y);console.log(t);break;case 80:console.log(gCanvas.clientWidth,gCanvas.clientHeight)}}function onWindowResize(){let e=gCanvas.parentNode.clientWidth,t=Math.max(600,gCanvas.parentNode.clientHeight);gRenderer.setSize(e,t),gCSS2DRenderer.setSize(e,t),gCamera.updateProjectionMatrix(),gCamera.aspect=e/t,gCamera.updateProjectionMatrix()}function animate(){if(requestAnimationFrame(animate),gRunAnimation){let e=5e-4*Date.now();gCamera.position.x=gRotRadius*Math.cos(e),gCamera.position.z=gRotRadius*Math.sin(e),gCamera.position.y=.4*gRotRadius*Math.sin(e/3)+.3*gRotRadius,gCamera.lookAt(0,0,0),gCamera.updateProjectionMatrix()}render()}function render(){gRenderer.render(gScene,gCamera),gCSS2DRenderer.render(gScene,gCamera)}init(),animate(),$("#light_intensity").on("input",function(e){gLight.intensity=e.target.value/10}),$("#mesh_size").on("input",function(e){gMesh.scale.x=e.target.value/50*.75+.25,gMesh.scale.y=e.target.value/50*.75+.25,gMesh.scale.z=e.target.value/50*.75+.25}),$("#switch_gt").on("change",function(e){for(var t=0;t<gGTCamList.length;t++)gGTCamList[t].visible=e.target.checked}),$("#switch_dark").on("change",function(t){t.target.checked?gScene.background=new e.Color(2236962):gScene.background=new e.Color(15658734)}),$("#switch_animation").on("change",function(e){e.target.checked?(gRunAnimation=!0,gRotRadius=Math.sqrt(gCamera.position.x**2+gCamera.position.z**2+gCamera.position.y**2)):gRunAnimation=!1}),$('#obj_list button[data-toggle="list"]').on("shown.bs.tab",function(e){selectCollection(e.target.id,gViewId)}),$('#view_list button[data-toggle="list"]').on("shown.bs.tab",function(e){selectCollection(gObjectId,e.target.id)}),$("#goto_reference").on("click",function(e){gCamera.position.x=gRefView.position.x,gCamera.position.y=gRefView.position.y,gCamera.position.z=gRefView.position.z,gCamera.lookAt(0,0,0),gCamera.updateProjectionMatrix()});