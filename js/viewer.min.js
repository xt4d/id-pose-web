import*as t from"three";import e from"three/addons/libs/stats.module.js";import{GLTFLoader as o}from"three/addons/loaders/GLTFLoader.js";import{OrbitControls as n}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as i,CSS2DObject as s}from"three/addons/renderers/CSS2DRenderer.js";let a,r,l,c,d,h;var p=null,u=null,m=[],g=[],w=[],b=null,f=null;function v(t){return'<div class="col-2"><img class="img-fluid img-thumbnail" src="'+t+'"></div>'}function y(e,o,n,i,a){const r=function(e,o,n){const i=new t.TextureLoader,a=new t.MeshBasicMaterial({map:i.load(e)});a.transparent=!0,a.side=t.DoubleSide;const r=new t.PlaneGeometry(.8,.8),l=new t.Mesh(r,a);l.position.set(0,0,-1);const c=new t.PerspectiveCamera(45,1,.001,1);c.position.x=o.x,c.position.y=o.z,c.position.z=-o.y,c.lookAt(new t.Vector3(0,0,0));const d=new t.CameraHelper(c);d.add(l);const h=document.createElement("div");h.className="label",h.textContent=n,h.style.color="black",h.style.backgroundColor="transparent";const p=new s(h);return p.position.set(0,0,.2),p.center.set(0,1),p.layers.set(0),[c,d,h]}(e,o,n),c=r[0],d=r[1],h=r[2];return d.setColors(i,i,i,i,i),l.add(c),l.add(d),c.updateProjectionMatrix(),d.update(),m.push(c),m.push(d),w.push(h),a&&(d.visible=$("#switch_gt").is(":checked"),g.push(d)),c}function _(e,n){for(var i=0;i<m.length;i++)l.remove(m[i]);m=[];for(i=0;i<w.length;i++)w[i].remove();w=[],g=[],console.log(e,n),function(e,o){if(null==e||null==o)return;fetch(e+"/"+o).then((t=>t.json())).then((o=>{$("#image_list").html("");var n="";const i=o.hasOwnProperty("cond_vid")?o.obs[o.cond_vid].sph:null;for(var s in o.obs){const r=e+"/cam/"+o.obs[s].img_path;var a=null;if(o.obs[s].hasOwnProperty("xyz"))a=o.obs[s].xyz;else{const t=s==o.cond_vid?[0,0,0]:o.obs[s].rel_sph;a=x(i[0]+t[0],i[1]+t[1],i[2]+t[2])}const l=y(r,a,s,s==o.cond_vid?new t.Color(16733525):new t.Color(5592575),!1);if(o.obs[s].hasOwnProperty("gt_rel_sph")){const e=o.obs[s].gt_rel_sph;y(r,a=x(i[0]+e[0],i[1]+e[1],i[2]+e[2]),s,new t.Color(5635925),!0)}s==o.cond_vid&&(f=l),n+=v(e+"/raw/"+o.obs[s].img_path)}$("#image_list").html(n),0==g.length?($("#switch_gt").attr("checked",!1),$("#switch_gt").prop("disabled",!0)):$("#switch_gt").prop("disabled",!1)}))}("data/"+e,n+".json"),e!=p&&(l.remove(b),b=null,function(t){const e=new o;$("#indicator").html("<b>Loading 3D mesh...</b>"),e.load(t,(function(t){$("#indicator").html("");const e=t.scene;e.position.x=0,e.position.y=0,e.position.z=0;const o=$("#mesh_size").val()/50*.75+.25;e.scale.x=o,e.scale.y=o,e.scale.z=o,e.traverse((t=>{t.isMesh&&(t.material.opacity=1,t.material.transparent=!0)})),l.add(e),b=e}))}("data/"+e+"/mesh.glb")),p=e,u=n}function x(t,e,o){return{x:o*Math.sin(t)*Math.cos(e),y:o*Math.sin(t)*Math.sin(e),z:o*Math.cos(t)}}function z(t){switch(t.keyCode){case 79:console.log(r.position.x,r.position.z,r.position.y);const t=function(t,e,o){const n=Math.pow(t,2)+Math.pow(e,2),i=Math.sqrt(n+Math.pow(o,2));return{theta:Math.atan2(Math.sqrt(n),o),azimuth:Math.atan2(e,t),radius:i}}(r.position.x,r.position.z,r.position.y);console.log(t);break;case 80:console.log(a.clientWidth,a.clientHeight)}}function M(){const t=a.parentNode.clientWidth,e=Math.max(600,a.parentNode.clientHeight),o=t/e;c.setSize(t,e),h.setSize(t,e),r.updateProjectionMatrix(),r.aspect=o,r.updateProjectionMatrix()}!function(){a=document.getElementById("c"),l=new t.Scene,l.background=new t.Color(15658734),d=new t.AmbientLight(16777215),l.add(d),$("#light_intensity").val(10),$("#mesh_size").val(50);const e=a.clientWidth,o=Math.max(600,a.clientHeight),s=e/o;r=new t.PerspectiveCamera(50,s,1,100),r.position.x=5,r.position.y=5,r.position.z=5,_("toyduck_photo","pose2"),c=new t.WebGLRenderer({canvas:a,antialias:!0}),c.setPixelRatio(window.devicePixelRatio),c.setSize(e,o),h=new i,h.setSize(e,o),h.domElement.style.position="absolute",h.domElement.style.top="0px",a.parentNode.appendChild(h.domElement);new n(r,h.domElement);window.addEventListener("resize",M),document.addEventListener("keydown",z)}(),function t(){requestAnimationFrame(t),c.render(l,r),h.render(l,r)}(),$("#light_intensity").on("input",(function(t){d.intensity=t.target.value/10})),$("#mesh_size").on("input",(function(t){b.scale.x=t.target.value/50*.75+.25,b.scale.y=t.target.value/50*.75+.25,b.scale.z=t.target.value/50*.75+.25})),$("#switch_gt").on("change",(function(t){for(var e=0;e<g.length;e++)g[e].visible=t.target.checked})),$("#switch_dark").on("change",(function(e){e.target.checked?l.background=new t.Color(2236962):l.background=new t.Color(15658734)})),$('#obj_list a[data-toggle="list"]').on("shown.bs.tab",(function(t){_(t.target.id,u)})),$('#view_list a[data-toggle="list"]').on("shown.bs.tab",(function(t){_(p,t.target.id)})),$("#goto_reference").on("click",(function(t){r.position.x=f.position.x,r.position.y=f.position.y,r.position.z=f.position.z,r.lookAt(0,0,0),r.updateProjectionMatrix()}));